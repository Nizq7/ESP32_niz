<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Smart Home Control</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; outline: none; }
        body { background: linear-gradient(135deg, #0f2027, #203a43, #2c5364); color: white; min-height: 100vh; padding: 20px; }
        .container { max-width: 400px; margin: 0 auto; }
        .header { text-align: center; margin-bottom: 30px; padding-top: 10px; }
        .welcome-section { text-align: center; background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.2); }
        .greeting { font-size: 24px; font-weight: 600; margin-bottom: 5px; }
        .location { font-size: 16px; opacity: 0.8; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .connection-status { display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 10px; height: 10px; border-radius: 50%; background: #4CAF50; }
        .status-dot.disconnected { background: #ff4444; }
        .status-text { font-size: 14px; font-weight: 500; }
        .devices-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .device-card { background: rgba(255,255,255,0.1); backdrop-filter: blur(20px); border-radius: 20px; padding: 20px; text-align: center; border: 1px solid rgba(255,255,255,0.2); transition: all 0.3s ease; cursor: pointer; }
        .device-card.active { background: rgba(76,175,80,0.2); border-color: rgba(76,175,80,0.5); }
        .device-icon { font-size: 32px; margin-bottom: 10px; opacity: 0.9; }
        .device-name { font-size: 14px; font-weight: 600; margin-bottom: 8px; }
        .device-status { font-size: 12px; opacity: 0.7; }
        .control-buttons { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .control-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); border-radius: 15px; padding: 15px; text-align: center; cursor: pointer; transition: all 0.3s ease; font-weight: 600; }
        .control-btn:hover { background: rgba(255,255,255,0.2); }
        .control-btn.all-on { background: rgba(76,175,80,0.3); border-color: rgba(76,175,80,0.5); }
        .control-btn.all-off { background: rgba(244,67,54,0.3); border-color: rgba(244,67,54,0.5); }
        .switch { position: relative; display: inline-block; width: 54px; height: 28px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(255,255,255,0.2); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 4px; bottom: 4px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #4CAF50; }
        input:checked + .slider:before { transform: translateX(26px); }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.5s ease forwards; }
        .device-card { -webkit-tap-highlight-color: transparent; outline: none; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header fade-in"><h1>Smart Light Control</h1></div>
        <div class="status-bar fade-in">
            <div class="connection-status"><div class="status-dot" id="wifiDot"></div><span class="status-text">WiFi: <span id="wifiStatus">Connecting...</span></span></div>
            <div class="connection-status"><div class="status-dot" id="mqttDot"></div><span class="status-text">MQTT: <span id="mqttStatus">Connecting...</span></span></div>
        </div>
        <div class="welcome-section fade-in"><div class="greeting">Hi Sami</div><div class="location">Welcome Home</div></div>
        <div class="welcome-section fade-in" style="animation-delay: 0.1s">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div><div class="greeting">Living Room</div><div class="location">4 Lights Control</div></div>
                <div class="location">Bedroom</div>
            </div>
        </div>
        <div class="control-buttons fade-in" style="animation-delay: 0.15s">
            <div class="control-btn all-on" onclick="controlAllDevices(true)"><div>ðŸ”† ALL ON</div></div>
            <div class="control-btn all-off" onclick="controlAllDevices(false)"><div>ðŸŒ™ ALL OFF</div></div>
        </div>
        <div class="devices-grid">
            <div class="device-card fade-in" style="animation-delay: 0.2s" onclick="toggleDevice(1)">
                <div class="device-icon">ðŸ’¡</div><div class="device-name">Light 1</div>
                <label class="switch"><input type="checkbox" id="light1"><span class="slider"></span></label>
                <div class="device-status" id="status1">OFF</div>
            </div>
            <div class="device-card fade-in" style="animation-delay: 0.3s" onclick="toggleDevice(2)">
                <div class="device-icon">ðŸ’¡</div><div class="device-name">Light 2</div>
                <label class="switch"><input type="checkbox" id="light2"><span class="slider"></span></label>
                <div class="device-status" id="status2">OFF</div>
            </div>
            <div class="device-card fade-in" style="animation-delay: 0.4s" onclick="toggleDevice(3)">
                <div class="device-icon">ðŸ’¡</div><div class="device-name">Light 3</div>
                <label class="switch"><input type="checkbox" id="light3"><span class="slider"></span></label>
                <div class="device-status" id="status3">OFF</div>
            </div>
            <div class="device-card fade-in" style="animation-delay: 0.5s" onclick="toggleDevice(4)">
                <div class="device-icon">ðŸ’¡</div><div class="device-name">Light 4</div>
                <label class="switch"><input type="checkbox" id="light4"><span class="slider"></span></label>
                <div class="device-status" id="status4">OFF</div>
            </div>
        </div>
        <div class="welcome-section fade-in" style="animation-delay: 0.6s; text-align: center;">
            <div class="location">Smart Home Control System</div>
            <div style="font-size: 12px; opacity: 0.6; margin-top: 8px;">Control your lights remotely with ESP32</div>
        </div>
    </div>

    <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
    <script>
        var mqttClient = null;
        var isMqttConnected = false;
        var reconnectInterval = 2000;
        
        // MQTT configuration
        const mqttConfig = {
            protocol: 'wss',
            host: '2ab5d234f212496e8ebf8830645f7dcd.s1.eu.hivemq.cloud',
            port: 8884,
            username: 'nizar',
            password: 'Niz774121',
            clientId: 'webclient_' + Math.random().toString(16).substr(2, 8),
            topics: {
                control: 'esp32/relays/control',
                status: 'esp32/relays/status',
                all: 'esp32/relays/all'
            }
        };

        function initMQTT() {
            try {
                updateConnectionStatus("mqttStatus", "mqttDot", "Connecting...", false);
                
                const url = `${mqttConfig.protocol}://${mqttConfig.host}:${mqttConfig.port}/mqtt`;
                
                const options = {
                    username: mqttConfig.username,
                    password: mqttConfig.password,
                    clientId: mqttConfig.clientId,
                    clean: true,
                    reconnectPeriod: 5000,
                    connectTimeout: 5000
                };

                mqttClient = mqtt.connect(url, options);

                mqttClient.on('connect', () => {
                    console.log("MQTT connected");
                    isMqttConnected = true;
                    updateConnectionStatus("mqttStatus", "mqttDot", "Connected", true);
                    
                    // Subscribe to status topics
                    mqttClient.subscribe(mqttConfig.topics.status, (err) => {
                        if (!err) console.log("Subscribed to status topic");
                    });
                    mqttClient.subscribe(mqttConfig.topics.all, (err) => {
                        if (!err) console.log("Subscribed to all topic");
                    });
                });

                mqttClient.on('message', (topic, message) => {
                    console.log("MQTT Received: " + topic + " = " + message.toString());
                    handleMQTTMessage(topic, message.toString());
                });

                mqttClient.on('error', (error) => {
                    console.log("MQTT error: " + error);
                    isMqttConnected = false;
                    updateConnectionStatus("mqttStatus", "mqttDot", "Error", false);
                });

                mqttClient.on('close', () => {
                    console.log("MQTT disconnected");
                    isMqttConnected = false;
                    updateConnectionStatus("mqttStatus", "mqttDot", "Disconnected", false);
                    setTimeout(initMQTT, reconnectInterval);
                });

            } catch (error) {
                console.log("MQTT init error: " + error);
                setTimeout(initMQTT, reconnectInterval);
            }
        }

        function handleMQTTMessage(topic, message) {
            try {
                const data = JSON.parse(message);
                
                if (topic === mqttConfig.topics.status) {
                    // Single device update
                    if (data.device && data.state !== undefined) {
                        updateDeviceStatus(data.device, data.state);
                    }
                } else if (topic === mqttConfig.topics.all) {
                    // All devices update
                    if (data.state !== undefined) {
                        updateAllDevicesStatus(data.state);
                    }
                }
            } catch (error) {
                console.log("MQTT message parse error: " + error);
            }
        }

        function sendMQTTCommand(topic, message) {
            if (isMqttConnected && mqttClient) {
                mqttClient.publish(topic, JSON.stringify(message));
                console.log("MQTT Sent: " + topic + " = " + JSON.stringify(message));
            } else {
                console.log("MQTT not connected, cannot send command");
            }
        }
        
        function updateConnectionStatus(statusId, dotId, text, connected) {
            var statusElement = document.getElementById(statusId);
            var dotElement = document.getElementById(dotId);
            
            if (statusElement) statusElement.textContent = text;
            if (dotElement) {
                dotElement.classList.toggle("disconnected", !connected);
                dotElement.style.background = connected ? "#4CAF50" : "#ff4444";
            }
        }
        
        function toggleDevice(deviceNum) {
            var checkbox = document.getElementById("light" + deviceNum);
            var newState = !checkbox.checked;
            
            var message = { device: deviceNum, state: newState };
            sendMQTTCommand(mqttConfig.topics.control, message);
            updateDeviceStatus(deviceNum, newState);
        }
        
        function controlAllDevices(state) {
            var message = { state: state };
            sendMQTTCommand(mqttConfig.topics.control, message);
            updateAllDevicesStatus(state);
        }
        
        function updateDeviceStatus(deviceNum, state) {
            var checkbox = document.getElementById("light" + deviceNum);
            var status = document.getElementById("status" + deviceNum);
            var card = document.querySelector(`.device-card:nth-child(${deviceNum})`);
            
            if (checkbox) checkbox.checked = state;
            if (status) {
                status.textContent = state ? "ON" : "OFF";
                status.style.color = state ? "#4CAF50" : "rgba(255,255,255,0.7)";
            }
            if (card) card.classList.toggle("active", state);
        }
        
        function updateAllDevicesStatus(state) {
            for (let i = 1; i <= 4; i++) updateDeviceStatus(i, state);
        }
        
        // Update WiFi status
        function updateWiFiStatus() {
            updateConnectionStatus("wifiStatus", "wifiDot", "Connected", true);
        }
        
        window.onload = function() {
            initMQTT();
            updateWiFiStatus();
            
            // Request initial status
            setTimeout(() => {
                if (isMqttConnected) {
                    sendMQTTCommand(mqttConfig.topics.control, { command: "status" });
                }
            }, 2000);
        };
    </script>
</body>
</html>